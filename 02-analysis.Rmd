---
title: "Cheese Analysis"
output:
  html_document:
    df_print: paged
knit: (function(inputFile, encoding) { rmarkdown::render(inputFile, encoding = encoding, output_dir = "docs") })
---

## Goals of this Notebook

- Look for trends in data
- Answer questions and find averages
- Play with visualizations

I want to explore my data by answering the following questions:

- What's going on in 2022? How have prices changed? How has cheese storage changed?
- Which year had the highest average cheese price? Which had the lowest?
- Which year had the highest average prices in 2021 dollars? Which had the lowest?
- Last year, which month had the highest total cheese prices?
- Which year had the highest cheese storage holdings, on average? Which had the lowest?

## About the data

This is [USDA](http://rmarkdown.rstudio.com) price data on domestic cheeses that I've collected, cleaned and adjusted for inflation.

Storage holdings data is in units of pounds.

## Setup

```{r setup}
library(tidyverse)
library(lubridate)
library(dplyr)
library(ggthemes)
library(scales)
```

## Import data

I'm importing my cleaned data here.

```{r import}
chs_clean <- readRDS("data-processed/01-cleaning.rds")
storage_clean <- readRDS("data-processed/01-storage.rds")
```

### Create average price column

Right now each row of my data has a corresponding high and low price for each week. I'll want a column that takes the average of those two prices for each week so I can get yearly averages. 

```{r avg_column}
chs_with_avg <- chs_clean |> 
  mutate(
    total_avg_price = (high_price + low_price)/2,
    total_price_adj = (adj_high_price + adj_low_price)/2
)

chs_with_avg |> glimpse()
```

### Create a month column

I also need to create a month column.

```{r month_column}
chs_mnths <- chs_with_avg |> 
  mutate(month_nm = month(date, label = TRUE)) #makes a month column
```

## Price analysis

### Which year had the highest average total cheese prices, not adjusted for inflation? Which had the lowest?

I'll group by year, which will put all the rows for each year together. Then I'll use the sum(mean) function to get the average of the total price column I just created for each year.

```{r unadj_yearly}
chs_with_avg_plot <- chs_with_avg |> 
  group_by(yr) |> 
  summarize(
    total_yr_price = mean(total_avg_price)
) |>
  arrange(total_yr_price |> desc())
```

2014 had the highest average cheese price, not adjusted for inflation, with all cheese packages averaging a price of $2.81 per pound in that years dollars.

2000 had the lowest average total cheese price in our data set, which was not adjusted for inflation, with an average minimum price of $1.65 per pound.

I'll chart this data here. 

```{r unadj_yearly_chart}
ggplot(chs_with_avg_plot, aes(x=yr)) + 
  geom_line(aes(y=total_yr_price)) + 
  labs(title = "Domestic Cheese Prices Over Time", 
       x = "Year", y = "Average Price of Cheese (dollars per pound)")
```

### 2022 prices

Let's see what the prices for all cheeses on average looked visually this year.

```{r thisyear_price}
thisyear_price <- chs_mnths |> 
  filter(yr == 2022) |> 
  group_by(date) |>  
  summarize(avg_price = mean(total_avg_price))

thisyear_price
```

Now I'll plot the data.

```{r thisyear_plot}
ggplot(thisyear_price, aes(x = date, y = avg_price)) +
  geom_line(aes(color = "pink")) +
  theme_classic() +
  theme(legend.position = "none") +
  labs(title = "Domestic cheese prices rise and fall in 2022", color = "Price",
       x = "Month", y = "Price per pound (in 2021 dollars)")
```


### Which year had the highest cheese prices in 2021 dollars? Which had the lowest?

I'll use the same logic here to find the highest total adjusted prices by year, but I'll sum the adjusted column instead.

```{r adj_yearly}
yearly_highest <- chs_with_avg |> 
  group_by(yr) |> 
  summarize(
    adj_yr_price = mean(total_price_adj)
) |>
  arrange(adj_yr_price |> desc())
```

Now I'll plot it.

```{r highest_price_year_plot}
ggplot(yearly_highest, aes(x = yr, y = adj_yr_price)) +
  geom_point(aes(color = "pink")) +
  geom_line(aes(color = "pink")) +
  theme_classic() +
  theme(legend.position = "none") +
  labs(title = "Total average domestic cheese prices fluctuate over time", color = "Price",
       x = "Year", y = "Price per pound (in 2021 dollars)")
```


2014 still had the highest total cheese prices after adjusting for inflation. The average price was 3.21 dollars per pound in 2021 dollars. 

The second highest year changed after adjusting for inflation, from 2022 with 2.79 dollars per pound to 2008 with 3.10 dollars per pound.

2018 had the lowest total cheese prices after adjusting for inflation, with an average price of 2.35 dollars per pound.

### In which month was the price of cheese the highest, on average?

First, I need to create a month column.

```{r month_column}
chs_mnths <- chs_with_avg |> 
  mutate(month_nm = month(date, label = TRUE)) #makes a month column
```

Now, I'll group by year and month, then month again to get the monthly average for all years.

```{r monthly}
chs_mnths |> 
  group_by(yr, month_nm) |> #group by both year and month first
  summarize(
   average_yearly_price = mean(total_price_adj)
) |> 
  group_by(month_nm) |>
  summarize(
    average_monthly_price = mean(average_yearly_price) #taking the average of the yearly average for each month
) |> 
  arrange(average_monthly_price |> desc()
)
```

October saw the highest average cheese prices in our data, with an average price of 2.83 dollars per pound in 2021 dollars.

### Last year's prices (2021)

I want to look at 2021 prices for each type of cheese.

```{r lastyear}
chs_mnths |>
  filter(yr == 2021) |> 
  group_by(type) |> #group by both month and type
  summarize(
   average_price = mean(total_avg_price) 
) |> 
  arrange(average_price |> desc()
)
```

Swiss was the most expensive type of cheese on average in 2021 with an average price of 3.52 dollars per pound. Process American cheese was the least expensive that year, with an average price of 1.84 dollars per pound.

Now I want to look at total 2021 prices by month. I'll filter to 2021 and then group by month.

```{r monthly_lastyear}
chs_mnths |>
  filter(yr == 2021) |> 
  group_by(month_nm) |> #group by both month and type
  summarize(
   average_monthly_price = mean(total_avg_price) 
) |> 
  arrange(average_monthly_price |> desc()
)
```

December 2021 saw the highest average total cheese price for that year, with an average price of 2.54 per pound.

### Swiss Cheese

I want to look at just Swiss prices, so I'll filter by data to Swiss and look at means again.

```{r swiss}
swiss_avg <- chs_clean |> 
  filter(str_detect(type, "SWISS")) |> 
  group_by(yr) |> 
  summarize(average_yearly_low = mean(low_price),
            average_yearly_high = mean(high_price),
            adj_yearly_high = mean(adj_high_price),
            adj_yearly_low = mean(adj_low_price)
  ) |> 
  arrange()

swiss_avg
```

Now I'll plot the data.

```{r swiss_plot}
ggplot(swiss_avg, aes(x=yr)) + 
  geom_line(aes(y=adj_yearly_high, color="High Price")) + 
  geom_line(aes(y=adj_yearly_low, color="Low Price")) +
  theme(legend.position = "none") +
  labs(title = "Swiss Cheese Prices Over Time", 
       x = "Year", y = "Price per pound (in 2021 dollars)")
```

### Muenster prices

```{r cheddar}
muenster <- chs_clean |> 
  filter(type == "MUENSTER") |> 
  group_by(yr) |> 
  summarize(
    yrly_adj_high_price = mean(adj_high_price),
    yrly_adj_low_price = mean(adj_low_price)
) |> 
  arrange(yrly_adj_high_price |> desc())
```

2014 saw the highest average Muesnter prices after inflation.

## Storage holdings analysis

### Which year had the highest cheese storage holdings, on average? Which had the lowest?

```{r storage}
storage_yrly <- storage_clean |>
  filter(
    data_item == "CHEESE, NATURAL, COLD STORAGE, CHILLED - STOCKS, MEASURED IN LB"
) |> 
  group_by(year) |> 
  summarize(
    avg_yrly_holding = mean(value)
) |> 
  arrange(avg_yrly_holding |> desc())

storage_yrly |> summary()
```

2022 had the highest average cheese storage holdings, with over 1.48 billion pounds of cheese stored by the U.S. government. 

2001 had the lowest average storage holdings in our data, with just over 700 million pounds stored.

### Plot storage over time

```{r yearly_storage}
ggplot(storage_yrly, aes(x=year)) + 
  geom_line(aes(y=avg_yrly_holding)) + 
  scale_y_continuous(labels = unit_format(unit = "B", scale = 1e-9)) + #changes y-axis units into billions
  theme(legend.position = "none") +
  labs(title = "National Cheese Storage Holdings Rise Over Time",
       subtitle = str_wrap("Government"),
       caption = "By Athena Hawkins",
       x = "Year", y = "Pounds of Cheese")
```

### Plot 2022 Storage

```{r monthly_storage}
storage_monthly <- storage_clean |> 
  filter(yr == 2022) |> 
  mutate(stor_month = month(date, label = TRUE)) |> 
  group_by(stor_month) |> 
  summarize(mnthly_lbs = mean(holdings_current_lbs)) |> 
  arrange()

storage_monthly
```

### 2022 Storage Plot

```{r storage_recent_plot}
ggplot(storage_monthly, aes(x=stor_month, y = mnthly_lbs)) + 
  geom_col() + 
  coord_flip()
  labs(title = "National Cheese Storage Holdings in 2022", 
       x = "Year", y = "Pounds of Cheese")
```


### Swiss cheese plot

```{r swiss}
swiss_avg <- chs_clean |> 
  filter(str_detect(type, "SWISS")) |> 
  group_by(yr) |> 
  summarize(average_yearly_low = mean(low_price),
            average_yearly_high = mean(high_price),
            adj_yearly_high = mean(adj_high_price),
            adj_yearly_low = mean(adj_low_price)
  ) |> 
  arrange()

swiss_avg
```

Now I'll plot the data.

```{r swiss_plot}
ggplot(swiss_avg, aes(x=yr)) + 
  geom_line(aes(y=adj_yearly_high, color="High Price")) + 
  geom_line(aes(y=adj_yearly_low, color="Low Price")) +
  labs(title = "Swiss Cheese Prices Over Time", 
       x = "Year", y = "Price per pound (in 2021 dollars)")
```

### Facet Wrap All Cheeses, Adjusted

```{r adj_facet_wrp}
facet_adj <- chs_with_avg |> 
  group_by(yr, type) |> 
  summarize(total_price_adj) |> 
  group_by(yr, type) |> 
  summarize(adj_yearly_price = mean(total_price_adj)) |>
  arrange()

facet_adj
```


```{r types}
separate_plot <- ggplot(facet_adj, aes(x = yr, y = adj_yearly_price)) + 
  geom_point(aes(color = type)) +
  geom_line(aes(color = type)) +
  labs(title = "U.S. Cheese Prices by Type (in 2021 dollars)", 
       x = "Year", y = "Price of Domestic Cheese")

separate_plot
```

```{r facet_plot}
facet_plot <- separate_plot +
  facet_wrap(~ type) +
  theme(legend.position = "none")

facet_plot
```

### Facet Wrap All Cheeses, Not Adjusted

```{r facet_unadj}
unadj <- chs_with_avg |> 
  group_by(yr, type) |> 
  summarize(total_avg_price) |> 
  group_by(yr, type) |> 
  summarize(unadj_price = mean(total_avg_price)) |>
  arrange()

unadj
```

```{r}
unadj_plot <- ggplot(unadj, aes(x = yr, y = unadj_price)) + 
  geom_point(aes(color = type)) +
  geom_line(aes(color = type)) +
  labs(title = "U.S. Cheese Prices by Type (not adjusted for inflation)", 
       x = "Year", y = "Price of Domestic Cheese")

unadj_plot
```

```{r}
unadj_facet <- unadj_plot +
  facet_wrap(~ type) +
  theme(legend.position = "none")

unadj_facet
```


```{r plot_save}
ggsave("plot1.pdf", plot=separate_plot, width=12, height=8)
```

```{r facet_save}
ggsave("plot2.pdf", plot=facet_plot, width=12, height=8)
```

## Lede draft

National cheese storage holdings have increased for the fifth year straight, according to U.S.D.A data.
